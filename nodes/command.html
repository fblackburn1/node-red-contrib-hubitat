<script src="/hubitat/js/common.js"></script>

<script type="text/javascript">
  /* global cleanHubitatSelectMenu, resetHubitatSelectMenu,
  cleanHubitatDevices, listHubitatDevices, loadCrendetials, paramsFromServer */

  function listHubitatDeviceCommands(server, deviceId, command) {
    const selectMenu = resetHubitatSelectMenu('node-input-command', 'Choose command...');
    $.getJSON(`hubitat/devices/${deviceId}/commands`, paramsFromServer(server), (res) => {
      const uniqueCommands = res.reduce((accumulator, value) => {
        if (!(value.command in accumulator) || (value.type.length && value.type[0] !== 'n/a')) {
          accumulator[value.command] = value;
        }
        return accumulator;
      }, {});
      Object.values(uniqueCommands).forEach((item) => {
        selectMenu.append($('<option>', {
          value: item.command,
          text: item.command,
          args_placeholder: item.type.join(','),
        }));
      });
      if (command in uniqueCommands) {
        selectMenu.val(command).trigger('change');
      }
    });
  }

  RED.nodes.registerType('hubitat command', {
    category: 'hubitat',
    color: '#ACE043',
    defaults: {
      deviceLabel: { value: '' },
      name: { value: '' },
      server: { type: 'hubitat config', required: true },
      deviceId: { value: '' },
      command: { value: '' },
      commandArgs: { value: '' },
    },
    inputs: 1,
    outputs: 1,
    align: 'right',
    icon: 'command.svg',
    label() { return this.name || this.deviceLabel || 'command'; },
    paletteLabel: 'command',
    oneditprepare() {
      $('document').ready(() => {
        $('#node-input-deviceLabel').hide();
        $('#node-input-server').change(() => {
          const serverId = $('#node-input-server option:selected').val();
          const server = RED.nodes.node(serverId);
          if (server) {
            loadCrendetials(server).then(() => { listHubitatDevices(server, this.deviceId); });
          } else {
            cleanHubitatDevices();
          }
        });
        $('#node-input-deviceId').change(() => {
          const deviceLabel = $('#node-input-deviceId option:selected').text();
          const deviceId = $('#node-input-deviceId option:selected').val();
          if (deviceId) {
            $('#node-input-name').attr('placeholder', deviceLabel);
            if (!this.name) {
              $('#node-input-deviceLabel').val(deviceLabel);
            }
          }
          const serverId = $('#node-input-server option:selected').val();
          const server = RED.nodes.node(serverId);
          if (server && deviceId) {
            loadCrendetials(server).then(() => {
              listHubitatDeviceCommands(server, deviceId, this.command);
            });
          } else {
            cleanHubitatSelectMenu('node-input-command', 'Choose command...');
            $('#node-input-deviceLabel').val('');
            $('#node-input-name').attr('placeholder', 'command');
          }
        });
        $('#node-input-name').change(() => {
          const name = $('#node-input-name').val();
          const deviceId = $('#node-input-deviceId option:selected').val();
          if ((!name) && (deviceId)) {
            const deviceLabel = $('#node-input-deviceId option:selected').text();
            $('#node-input-deviceLabel').val(deviceLabel);
          }
        });
        $('#node-input-command').change(() => {
          let placeholder = $('#node-input-command option:selected').attr('args_placeholder');
          const commandArgsInput = $('#node-input-commandArgs');
          if (placeholder === 'n/a') {
            commandArgsInput.val('');
            commandArgsInput.prop('disabled', true);
          } else {
            commandArgsInput.prop('disabled', false);
          }
          if (placeholder === 'COLOR_MAP') {
            placeholder = '{"hue":88,"saturation":50,"level":90} or {"hex":"15fe21"}';
          }
          commandArgsInput.attr('placeholder', placeholder);
        });
      });
    },
  });
</script>

<script type="text/html" data-template-name="hubitat command">
  <div class="form-row">
    <label for="node-input-server"><i class="fa fa-globe"></i> Server</label>
    <input type="text" id="node-input-server">
  </div>
  <div class="form-row">
    <label for="node-input-deviceId"><i class="fa fa-lightbulb-o"></i> Device</label>
    <select id="node-input-deviceId"></select>
  </div>
  <div class="form-row">
    <label for="node-input-command"><i class="fa fa-hashtag"></i> Command</label>
    <select id="node-input-command"></select>
  </div>
  <div class="form-row">
    <label for="node-input-commandArgs"><i class="fa fa-bars"></i> Arguments</label>
    <input type="text" id="node-input-commandArgs">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <!-- to be handled by NR framework-->
  <div class="form-row">
    <label for="node-input-deviceLabel"></label>
    <input type="text" id="node-input-deviceLabel">
  </div>
</script>

<script type="text/html" data-help-name="hubitat command">
  <p>A node that send command to Hubitat.</p>

  <h3>Inputs</h3>
    <dl class="message-properties">
      <dt class="optional">msg.deviceId <span class="property-type">string</span></dt>
      <dd>Allow to overwrite the device.</dd>
    </dl>
    <dl class="message-properties">
      <dt class="optional">msg.command <span class="property-type">string</span></dt>
      <dd>Allow to overwrite the command sent.</dd>
    </dl>
    <dl class="message-properties">
      <dt class="optional">msg.arguments <span class="property-type">string</span></dt>
      <dd>Allow to overwrite the command arguments sent. You must remove this property
        if you send a command that doesn't require an argument</dd>
    </dl>

  <h3>Output</h3>
    The same message as the input.

  <h3>Details</h3>
    <p><b>Device</b> dropdown is populated when the server is reachable.</p>
    <p><b>Command</b> dropdown is populated when the <b>Device</b> is selected.
      If not specified, input message must define <code>command</code> property</p>
    <p><b>Arguments</b> field is disabled or placeholder is set according to the chosen <b>Command</b>.
      If not specified, input message must define <code>arguments</code> property</p>
    <p>This node is not compatible with Node-RED 0.x</p>
</script>
